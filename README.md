# Telegram-бот для аналитики по видео

Проект реализует Telegram-бота на **aiogram**, который принимает вопросы на русском языке и возвращает одно числовое значение, рассчитанное по статистике видео. Вопрос преобразуется в SQL-запрос с помощью LLM, после чего выполняется в PostgreSQL.

## Состав проекта

- `app/models.py` — SQLAlchemy модели `videos` и `video_snapshots`.
- `app/load_data.py` — загрузка `videos.json` в PostgreSQL.
- `app/api.py` — запрос к LLM (Groq) и очистка ответа до SQL.
- `app/db.py` — пул соединений и выполнение SQL.
- `app/handlers.py` — обработчики Telegram-бота.
- `main.py` — запуск бота + начальная загрузка данных.

## Архитектура и подход к NLP → SQL

1. Бот получает текст вопроса на русском.
2. В `app/api.py` вызывается LLM (Groq) с системным промптом, где:
   - детально описана схема таблиц `videos` и `video_snapshots` (типы полей, смысл колонок);
   - заданы правила, какие вопросы относятся к итоговой статистике (`videos`) и какие — к динамике/приростам (`video_snapshots`);
   - закреплено требование возвращать **только** `SELECT` с одним числовым столбцом.
3. LLM возвращает готовый SQL-запрос для PostgreSQL без пояснений.
4. Ответ очищается от обёрток и передаётся в `app/db.execute_sql`.
5. Выполняется запрос и возвращается одно число.

Промпт находится в `app/config.py` в переменной `SYSTEM_PROMPT` и содержит:

- строгие правила на формат ответа (только SQL, только `SELECT`, один столбец/одно число);
- полное описание схемы таблиц `videos` и `video_snapshots` с назначением колонок:
  - `videos`: финальные значения (`views_count`, `likes_count`, `comments_count`, `reports_count`) и дата публикации `video_created_at`;
  - `video_snapshots`: почасовые замеры `created_at` и приросты `delta_*` по каждому видео;
- правила сопоставления естественного языка и SQL:
  - вопросы про количество видео, финальные просмотры/лайки/комментарии — `videos`;
  - вопросы про «выросли», «получили новые», «прирост» — `video_snapshots` и `delta_*`;
  - фильтрация по датам через `created_at::date` и диапазоны `BETWEEN` для интервалов;
  - для подсчёта уникальных видео в динамике — `COUNT(DISTINCT video_id)` с фильтром по `delta_* > 0`;
  - если запрос некорректен — вернуть `SELECT`, который вернёт 0.

## Требования

- Python 3.12+
- PostgreSQL 15+
- Переменные окружения (см. `.env.template`)

## Как задать токен Telegram-бота

1. Создайте бота через `@BotFather` и получите токен.
2. Запишите токен в переменную окружения `BOT_TOKEN`:
   - в `.env` при запуске через Docker;
   - или в локальном окружении (см. пример ниже).

## Запуск через Docker

1. Скопируйте шаблон окружения:

```bash
cp .env.template .env
```

2. Заполните `.env`:

- `DATABASE_URL` — строка подключения SQLAlchemy, например:
  ```
  postgresql+asyncpg://POSTGRES_USER:POSTGRES_PASSWORD@db:5432/POSTGRES_DB
  ```
- `BOT_TOKEN` — токен Telegram-бота из BotFather.
- `API_KEY` — ключ Groq API.
- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB` — учётные данные PostgreSQL.

3. Запустите сервисы:

```bash
docker compose up --build
```

Контейнер `bot` автоматически создаст таблицы и загрузит данные из `videos.json` при старте.

## Запуск локально (без Docker)

1. Установите зависимости:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

2. Создайте файл `.env` и задайте переменные (аналогично Docker). Пример для локальной БД:

```
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/vid_stats
BOT_TOKEN=...
API_KEY=...
```

3. Убедитесь, что PostgreSQL запущен, и выполните:

```bash
python main.py
```

## Загрузка данных

Данные загружаются автоматически при старте приложения. Скрипт `app/load_data.py`:
- создаёт таблицы через SQLAlchemy;
- читает `videos.json`;
- записывает данные в `videos` и `video_snapshots`.

## Примеры запросов

- «Сколько всего видео есть в системе?»
- «Сколько видео у креатора с id ... вышло с 1 ноября 2025 по 5 ноября 2025 включительно?»
- «Сколько видео набрало больше 100 000 просмотров за всё время?»
- «На сколько просмотров в сумме выросли все видео 28 ноября 2025?»
- «Сколько разных видео получали новые просмотры 27 ноября 2025?»

## Промпт LLM

Используется системный промпт в `app/config.py` (`SYSTEM_PROMPT`). В нём схема данных расписана текстом: перечислены таблицы, колонки, типы и их смысл. Примеры соответствия:

- «сколько всего видео» → `SELECT COUNT(*) FROM videos`
- «сколько видео у креатора ... за период» → `SELECT COUNT(*) FROM videos WHERE creator_id = ... AND video_created_at::date BETWEEN ...`
- «на сколько просмотров выросли все видео за дату» → `SELECT SUM(delta_views_count) FROM video_snapshots WHERE created_at::date = ...`
- «сколько разных видео получали новые просмотры» → `SELECT COUNT(DISTINCT video_id) FROM video_snapshots WHERE delta_views_count > 0 AND created_at::date = ...`

Таким образом, преобразование текста в SQL происходит за счёт строгого промпта и прямого маппинга терминов (итоговые значения → `videos`, динамика/прирост → `video_snapshots`). При необходимости корректировки логики запросов редактируйте этот промпт.
